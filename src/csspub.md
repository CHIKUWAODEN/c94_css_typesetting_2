# CSS組版をどうやっていくか
{: .counting }

## Webook について
{: .counting }

まえがきでも少し触れましたが、Webook とはどうゆうツールなのかについて解説します。
Webook は Markdown -> HTML -> PDF と変換するツールです。
Web ブラウザ上でのプレビューなどは想定しておらず（中間ファイルとして出力はしています）、印刷データとするための PDF をワンストップで作成することを目的としています。
作業中でも、常に最終的な成果物をもって確認しつつ進めていくというスタイルに対応することを念頭においています。
Markdown から HTML への変換は kramdown、HTML から PDF への変換には wkhtmltopdf を利用しています。


## Webook の既知の問題とその解決
{: .counting }

C85 Webook 本のときにある程度まとめて、それについて書いていたはずなのでまずはそこを見返しておきます。
これらの問題は、wkhtmltopdf を利用している以上回避できない問題も含んでいます。
後に解説しますが、問題の回避のために wkhtmltopdf から脱却したかったというのが本書の目的としたところの一つであります。


<%= pagebreak %>

### 脚注をページの下部に配置できない
{: .counting }

**問題点**

技術書における脚注というと通常、脚注を入れたページと同じページ下部に置くものかと思いますが、Webook の脚注は、その章の最後に出てきてしまいます。
問題の質としては致命的ではないのですが、一般的な技術書の体裁を目指す上では無視できません。
サッと目を移せる位置に情報が配置できるようにしておきたいものです。

**解決方法**

印刷時に脚注のレイアウトを制御する CSS があるのですが、wkhtmltopdf を通すとこれを使うことができません。
この CSS に独自の実装をもって対応しているプロダクトは世の中にあったりするのですが、プロプライエタリなソフトウェアだったり Webook のスタックの一部として採用するには若干相性が悪かったりするなどの理由で、現実に解決するまで至りませんでした。
このあたりについて検討した内容については、後ほどあらためて解説していますので、そちらをご覧ください。


### 画像や表のナンバリング
{: .counting }

**問題点**

図や表を自動的に採番して、キャプションとして付け加えるといったアレです。
自分が普段つくる程度の本ではさほど困ることはありませんが、資料として画像や表を多用するようなスタイルを取るような場合に、
適切な画像の参照先を具体的に提示しづらいというのは問題があります。

**解決方法**

CSSカウンタという機能を使うことで解決できます。
まず、次のようなスタイルシートを記述します。


    h1.counting {
        counter-reset: ... figcount;
    }
    figure {
        text-align: center;
    }
    figure > img {
        counter-increment: figcount;
    }
    figure > figcaption {
        display: inline;
    }
    figure > figcaption::before {
        content: "図" counter(chapter) "." counter(figcount)
    }


そして、次のような HTML タグを記述します。


    <figure>
        <img src="http://localhost:9999/images/job_it_dokata.png" style="width: 30%;">
        <br>
        <figcaption>IT土方のイラスト</figcaption>
    </figure>
    <figure>
        <img src="http://localhost:9999/images/book_gijutsusyo_ai.png" style="width: 30%;">
        <br>
        <figcaption>技術書のイラスト</figcaption>
    </figure>


以下は、実際に表示してみたものです。イラストはおなじみ「いらすとや」さんからお借りしました。


<figure>
    <img src="http://localhost:9999/images/job_it_dokata.png" style="width: 30%;">
    <br>
    <figcaption>IT土方のイラスト</figcaption>
</figure>
<figure>
    <img src="http://localhost:9999/images/book_gijutsusyo_ai.png" style="width: 30%;">
    <br>
    <figcaption>技術書のイラスト</figcaption>
</figure>


ちなみに、このCSSカウンタを使うテクニックで、`h1` タグなどを目安に章や節に自動的に採番することも可能です。
実際に本書では、CSSカウンタとヘッダにクラスを付加することで対応しています。
今回はそこまではやっていませんが、コードブロックや表なんかも同じ要領で採番できると思います。


### 章や節への名前付けと展開
{: .counting }

**問題点**

こちらも画像や表のナンバリングと似たような問題になるのですが、それなりの文書になってくるとその文書の中で「第1章1節 Hello, World!! を参照せよ」などと指示する場面が必ずといっていいほど出きます。
ここで直接記入してしまうと、文章の構造を入れ替えたり差し込んだりした場合に、直接記入した場所ももらさずにすべて修正する必要がでてきます。
そのため、参照したい場所に適当な ID を割り当て、その ID を通して章や節の番号やタイトルを展開するようにしておけば、文書の構造が変わったとしても問題はありません。

**解決方法**

* Markdown パーサに kramdown を使っているので、出力する前に Ruby 側で処理してしまう
* クラス名などを記述して、JavaScript で処理してしまう

などと、どうにかする目算はあるのですが、締切的なあれに間に合わずに具体的な実装に落とし込むに至りませんでした。
今後どうにかしていきたい気持ちはあります。


## 結局のところ全部は解決できてない
{: .counting }

**結局のところ、すべての課題解決することはできなかったのですが**CSS組版向けの機能についての現状についてけっこう勉強になりました。
意外に組版向けの CSS の機能をサポートしているブラウザは一般的でないとか、それらを実現するたに各社が独自の実装を行い製品としていることなど、本書を書いていなければ知ることもなかったでしょう。
Webook に関する取り組みは今後も継続的にやっていければと思っているので、次につながる知識が得られたと思います。