ERB への対応
========
{: .counting }


ERB 処理を実行するようにしてみた
--------
{: .counting }

変換前の Markdown の時点で ERB の処理を行うようにしました。
現状ではそれほど役に立つことはないが、たとえば複雑なマークアップを記述しなければならない場合のヘルパーであるとか、そういった使い道を想定しています。


たとえば

    <%%= footenote 脚注 %>
    
とすると

    <span class="footnote">脚注</span>

のように、HTML を出力するようにするなどの使い方が想定できます。
実際に本書の執筆においては、改ページの調整をやりやすくするためにヘルパとして `pagebreak()` とういう関数を定義して利用しています。


九九を表示してみる
--------
{: .counting }

ためしに、ERB で九九を表示してみます。
次のようなマークアップを Markdown ファイルの中に直接記述します。

<%= pagebreak %>


    <table>
    <%% (1..9).each do |x| %>
    <tr>
    <%% (1..9).each do |y| %>
    <td>
    <%%= sprintf "%2d", x * y %>
    </td>
    <%% end %>
    </tr>
    <%% end %>
    </table>


この例は少し残念ですが、半端なインデントを行うと kramdown がどうやら整形済みテキストブロックであると勘違いして意図しない HTML が生成されます。
そのため、やや不格好ですが、これはインデントは行わないようにしています。
次が実際に、ERB 処理によって出力されたものです。


<table>
<% (1..9).each do |x| %>
<tr>
<% (1..9).each do |y| %>
<td>
<%= sprintf "%2d", x * y %>
</td>
<% end %>
</tr>
<% end %>
</table>


このくらいの例だとイマイチ存在感が薄いかと思いますが、他にも命令分岐をかけたり、データを自動的に取得してきたりなどの使い方に応用できます。


ヘルパー関数を定義する
--------
{: .counting }

これは簡単で、単にグローバルスコープに関数を記述すると、それを呼び出すことができるようです。
たとえば、このような関数を定義するとします。
大したことではないですが、文字列を出力するのではなく文字列を返すようにしているのがポイントです。


    def hello(name)
        "Hello, #{name}!!"
    end


これを次のように記述するとします。


    <%%= hello('World') %>


得られる結果が次のようになります。


    <%= hello('World') %>



自前のヘルパーを定義する
--------
{: .counting }

hello ヘルパは Webook に組み込まれたものですが、必要に応じて自前のヘルパを定義することができます。
`template/erb_helper.rb` というファイルを定義しておいておくことで、そこで定義された関数はヘルパとして利用することができるようになっています。
現状のところでは、このヘルパ記述用のファイルは `webook create` では生成されないようになっているので、自前のヘルパーを使う場合に自前で定義するようにします。


### ヘルパーの例：画像を表示する
{: .counting }

ヘルパーの例として、画像とキャプションの記述を簡単に行うためのヘルパーを記述してみようと思います。
`template/erb_helper.rb` の中に、次のような関数を定義します。

    def image(src, caption)
        <<"EOS"
    <figure>
    <img src='http://localhost:9999/#{src}' style='width: 30%;'>
    <br>
    <figcaption>#{caption}</figcaption>
    </figure>
    EOS
    end

九九の例と同じく、インデントしてしまうと kramdown にコードブロックと解釈されてしまうので、わざとインデントをつけないように記述しています。
これを、次のように呼び出します。

    <%%= image('images/sushi_maguro_dukushi_big.png', 'まぐろ寿司セットのイラスト（海苔巻付き）') %>

実際に表示されるものがこちらです。

<%= image('images/sushi_maguro_dukushi_big.png', 'まぐろ寿司セットのイラスト（海苔巻付き）') %>